# Test Specifications

このディレクトリには、AI Agent File-Based Workflow で必要とされる5つのツールのテストスペックが含まれています。

## 📋 テストファイル一覧

### 1. start_session.test.ts
- **テスト対象**: `src/start_session.ts`
- **主要テストケース**:
  - 入力検証（ファイル存在性、JSON構文、必須フィールド）
  - ディレクトリ構造作成（セッション、AI作業領域）
  - 決定要求ファイル生成（GM用、パーティー用）
  - 出力形式検証
  - エラーハンドリング

### 2. process_ai_responses.test.ts
- **テスト対象**: `src/process_ai_responses.ts`
- **主要テストケース**:
  - 決定応答ファイル読み込み
  - JSONスキーマ検証
  - アクション実行（市場取引、リソース管理）
  - プレイログエントリ生成
  - ファイルクリーンアップ
  - nextStatus判定
  - エラー処理制限

### 3. append_playlog.test.ts
- **テスト対象**: `src/append_playlog.ts`
- **主要テストケース**:
  - AIナラティブ読み込み
  - 決定応答ファイル復元
  - 世界状態差分計算
  - プレイログエントリ構築
  - JSONL追記機能
  - step番号自動計算

### 4. generate_next_turn.test.ts
- **テスト対象**: `src/generate_next_turn.ts`
- **主要テストケース**:
  - 世界状態読み込み
  - 決定要求ファイル生成
  - contextData動的生成（GM用、パーティー用）
  - 利用可能アクション判定
  - ターン番号管理
  - 終了条件チェック

### 5. finalize_session.test.ts
- **テスト対象**: `src/finalize_session.ts`
- **主要テストケース**:
  - 最終世界状態保存
  - 作業ファイルクリーンアップ
  - セッションメタデータ更新
  - サイズ計算
  - 競合状態処理

## 🚀 テスト実行方法

### 全テスト実行
```bash
npm test
```

### 特定ツールのテスト実行
```bash
npm test start_session.test.ts
npm test process_ai_responses.test.ts
npm test append_playlog.test.ts
npm test generate_next_turn.test.ts
npm test finalize_session.test.ts
```

### カバレッジ付きテスト実行
```bash
npm run test:coverage
```

### ウォッチモード
```bash
npm run test:watch
```

## 🔧 テスト設定

### vitest.config.ts
- **環境**: Node.js
- **タイムアウト**: 10秒
- **カバレッジ**: v8プロバイダー、80%閾値
- **分離**: 各テストファイルを独立実行

### setup.ts
- **グローバル設定**: テスト環境変数
- **クリーンアップ**: テスト用ディレクトリの自動削除

## 📊 テストカバレッジ要件

各ツールは以下のカバレッジ閾値を満たす必要があります：

- **ブランチカバレッジ**: 80%以上
- **関数カバレッジ**: 80%以上
- **行カバレッジ**: 80%以上
- **ステートメントカバレッジ**: 80%以上

## 🎯 テスト設計原則

### 1. 完全性
- 全ての主要機能をテスト
- 正常系・異常系両方をカバー
- エッジケースの考慮

### 2. 独立性
- 各テストケースは独立して実行可能
- テスト間の依存関係を排除
- テストデータの完全分離

### 3. 現実性
- 実際の使用パターンに基づくテストデータ
- AI Agent File-Based Workflowの実行フローを反映
- エラー条件の現実的なシミュレーション

### 4. 保守性
- テストデータの再利用性
- ヘルパー関数による重複排除
- 明確なテスト構造とドキュメント

## 🗂️ テストデータ構造

### 世界状態テストデータ
```typescript
// 2つのパーティー（火の鍛冶ギルド、エメラルド探索隊）
// 複数の地域（山岳、森林、市場町）
// 市場データ（価格、履歴、取引）
// パーティー関係（信頼、協力）
```

### 決定応答テストデータ
```typescript
// 有効な決定応答（market_trade, explore等）
// 無効な決定応答（リソース不足、構文エラー等）
// meta.llmDecision情報（思考プロセス記録）
```

### ナラティブテストデータ
```typescript
// ENHANCED_NARRATIVE_STRUCTURE準拠
// 5つの主要セクション（内部視点、外部交流等）
// 日本語コンテンツでの詳細記述
```

## 🚨 注意事項

### ファイルシステム操作
- テスト用ディレクトリ（`test_autonomous_sessions`）を使用
- 本番環境の`autonomous_sessions`に影響しない
- 各テスト後の完全クリーンアップ

### 非同期処理
- 全てのファイル操作はasync/await
- 適切なタイムアウト設定
- エラーハンドリングの徹底

### モック使用時の考慮
- ファイルシステム操作は実際のファイルを使用
- 外部依存（Universal Narrative Engine等）のみモック
- テストの信頼性を最優先

## 📈 継続的改善

### テスト追加指針
1. 新機能追加時は対応するテストケースを必ず追加
2. バグ修正時は再現テストケースを追加
3. パフォーマンス要件の変更時はベンチマークテスト追加

### リファクタリング指針
1. テストファーストでのリファクタリング
2. 既存テストの通過を保証
3. カバレッジ低下の防止

このテスト仕様により、AI Agent File-Based Workflowの5つのツールが正確に動作し、AI Agentによる完全自律的なTRPGセッション実行が保証されます。